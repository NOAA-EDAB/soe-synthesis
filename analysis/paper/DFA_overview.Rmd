---
title: "Dynamic Factor Analysis"
author: "Scott Large"
date: "7/21/2020"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      include = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      dpi=300,
                      fig.width=10,
                      fig.height = 10)

## Install required packages
# remotes::install_github("nwfsc-timeseries/MARSS")
# remotes::install_github("DavisVaughan/furrr")
# install.packages("broom")

# library(tictoc)
library(MARSS)
library(dplyr)
library(tidyr)
library(broom)
library(purrr)
library(furrr)
library(ggplot2)
library(ggrepel)
library(patchwork)

## Helper function to extract DFA fits ##
get_dfa_fits <- function(MLEobj, dd = NULL, alpha = 0.05, return_tidy = TRUE) {
  ## empty list for results
  fits <- list()
  ## extra stuff for var() calcs
  Ey <- MARSS:::MARSShatyt(MLEobj)
  ## model params
  ZZ <- coef(MLEobj, type = "matrix")$Z
  ## number of obs ts
  nn <- dim(Ey$ytT)[1]
  ## number of time steps
  TT <- dim(Ey$ytT)[2]
  ## get the inverse of the rotation matrix
  H_inv <- varimax(ZZ)$rotmat
  ## check for covars
  if (!is.null(dd)) {
    DD <- coef(MLEobj, type = "matrix")$D
    ## model expectation
    fits$ex <- ZZ %*% H_inv %*% MLEobj$states + DD %*% dd
  } else {
    ## model expectation
    fits$ex <- ZZ %*% H_inv %*% MLEobj$states
  }
  ## Var in model fits
  VtT <- MARSSkfss(MLEobj)$VtT
  VV <- NULL
  for (tt in 1:TT) {
    RZVZ <- coef(MLEobj, type = "matrix")$R - ZZ %*% VtT[,
                                                         , tt] %*% t(ZZ)
    SS <- Ey$yxtT[, , tt] - Ey$ytT[, tt, drop = FALSE] %*%
      t(MLEobj$states[, tt, drop = FALSE])
    VV <- cbind(VV, diag(RZVZ + SS %*% t(ZZ) + ZZ %*% t(SS)))
  }
  SE <- sqrt(VV)
  ## upper & lower (1-alpha)% CI
  fits$up <- qnorm(1 - alpha/2) * SE + fits$ex
  fits$lo <- qnorm(alpha/2) * SE + fits$ex
  fits$raw <- MLEobj$marss$data
  if(return_tidy){
    colnames(fits[["ex"]]) <-  colnames(MLEobj$call$data)
    colnames(fits[["up"]]) <-  colnames(MLEobj$call$data)
    colnames(fits[["lo"]]) <-  colnames(MLEobj$call$data)
    colnames(fits[["raw"]]) <-  colnames(MLEobj$call$data)
   
    fits <- purrr::map_df(fits, ~ as.data.frame(.x), .id = "id") %>% 
      dplyr::group_by(id) %>% 
      dplyr::mutate(comname =  rownames(MLEobj$call$data)) %>% 
      tidyr::pivot_longer(-c(comname, id), names_to = "Time", values_to = "val") %>%
      tidyr::pivot_wider(names_from = id, values_from = val) %>% 
      dplyr::mutate(Time = as.numeric(Time))
    return(fits)
  }
  if(!return_tidy){
    return(fits)
  }
}

```

## Introduction

1. EBFM and IEA yadda yadda yadda
1. The need for synthesis in IEAs
    + Improving story-telling with indexes
    + Creating hypotheses for causal relationships
    + Move from "so-what" towards opperational EBFM/EAFM
1. The State of the Ecosystem Report (SOE) has many indicators but explaining teleconnections and "bigger picture" messages remains a challenge.
1. Here, we seek to reduce the dimensionality of data to:
    + identify common trends between indicators to serve as an ecosystem index
    + identify covariates that improve explanatory power of common trends
    + ?
1. DFAs identify latent trends in time-series using some fancy-pants maths.
    + We are tracking stability using feeding guilds. 
        + If we use raw species kg/tow survey data to identify common trends between species, these might provide additional/better/other insight into ecosystem stability. 
        + Covariates can also be included to identify hypotheses that might be useful for improved management  
        + *n.b. VAST can do spatial DFA, so this could all be done within a single framework -- I don't know how or if it would require unreasonable computing resources* 
    + Potential covariate data: environmental (e.g., SST, BT, and chla) and socio-economic (e.g., revenue, engagement, landings, etc)

## Materials and Methods

# Data


1. Survey data
    + For each ecoregion, select the *n* species that occur in *x* tows and aggregate to annual/seasonal
    + *VAST, we would just need to filter for subset of species and not worry about aggregating to annual/seasonal values.*
1. Environmental data
    + For each ecoregion: Seasonal bottom temperature,
    + Basin-wide: NAO, AMO, ...? 
    + *VAST could use interpolated station data from Kevin*



# Modeling

We used [MARSS](https://cran.r-project.org/web/packages/MARSS/index.html) DFA as a dimension reduction tool. 

```{r get-fits}

mod_path <- "\\\\net.nefsc.noaa.gov/home5/slarge/projects/soe-synthesis/analysis/models/"

mod_list <- tibble(file_path = list.files(mod_path)) %>%
  filter(!grepl("^kemz.*|model_out.*|marss-dfa.*|GB_fall-model_list.*|*.R", file_path)) %>% 
  mutate(out = gsub(".rds", "", file_path),
         file_path = paste0(mod_path, file_path)) %>% 
  separate(col = out, sep = "-", into = c("EPU", "Season", "R", "m",
                                          "covariateA", "covariateB", "covariateC", "covariateD", "covariateE"),
           fill = "right",
           remove = TRUE) %>% 
  mutate(covariateA = ifelse(covariateA == "NA",
                             NA, 
                             covariateA))

future::plan(future::multiprocess)
mod_out <- mod_list %>%
  mutate(AICc = furrr::future_map(file_path, function(x) readRDS(x)$AICc, .progress = FALSE)) %>%
  unnest(AICc) %>%
  ungroup()

```


## Results





```{r model-selection, fig.cap="DFA model selection.  \\label{fig:model-selection}"}

mod_dat <- mod_out %>%
  filter(R != "unconstrained") %>%
  group_by(EPU, Season) %>%
  mutate(delta_AICc = AICc - min(AICc)) %>% 
  ungroup() %>% 
  mutate(wt = exp(-0.5*delta_AICc),
         Ak_wt = wt/sum(wt),
         Ak_wt_cum = cumsum(Ak_wt),
         n_covariate = rowSums(!is.na(select(., starts_with("cov"))))) %>%
  pivot_longer(cols = starts_with("cov"), names_to = "all_cov") %>%
  select(-all_cov) %>%
  group_by(EPU, Season) %>%
  mutate(value = ifelse(n_covariate == 0,
                        "none", value),
         best_model = ifelse(AICc == min(AICc),
                             "Best Model",
                             NA)) %>%
  distinct(.keep_all = TRUE) %>%
  filter(!is.na(value))

model_plot <- ggplot() +
  geom_point(data = mod_dat %>%  filter(n_covariate <= 1),
             aes(x = m, y = delta_AICc, shape = R, color = value)) +
  geom_point(data = mod_dat %>%  filter(n_covariate >= 2),
             aes(x = m, y = delta_AICc, shape = R, color = value), alpha = 0.8, position = position_jitter(w = 0.4, h = 0.0)) +
  geom_label_repel(
    data = mod_dat %>% filter(!is.na(best_model)), aes(x = m, y = delta_AICc), label = "Best Model", size = 4,
    box.padding = 1, point.padding = 0, min.segment.length = 0, force = 0.5) +
  facet_grid(EPU + Season ~ n_covariate) +
  scale_color_brewer(type = "qual", palette = "Set1") +
  labs(title = "DFA model selection",
       subtitle = "Number of covariates",
       color = "Covariate",
       y = "\u0394 AICc",
       x = "Number of trends") +
  theme_bw() +
  theme(axis.text.y = element_text(size = rel(.6)),
        legend.position = "bottom")

model_plot

```


```{r best-model}

## Grab the best models and get all the relevant info from the MARSSobj
best_mod <- mod_dat %>%
  filter(!is.na(best_model)) %>%
  group_by(EPU, Season) %>% 
  mutate(dat = purrr::map(file_path, ~readRDS(.x)), ## Get best models for each EPU and Season
         sp_dat = purrr::map(dat, c("call", "data")), 
         comname = purrr::map(sp_dat, ~rownames(.x)), ## Get the imput rows
         trends = map(dat, tidy, type = "states"), ## Output trends
         z_est = map(dat, ~coef(.x, type = "matrix")$Z),
         h_inv = map(z_est, ~varimax(.x)$rotmat),
         z_rot = map2(.x = z_est, .y = h_inv, ~ data.frame(.x %*% .y)), ## Loadings
         fits = purrr::map(dat, get_dfa_fits)) %>%  ## and model fits
  select(-sp_dat, -z_est, -h_inv, -dat) ## remove extra and big files

sp_names <- best_mod %>% 
  select(EPU, Season, comname) %>% 
  unnest(comname)

sp_guild <- ecodata::nefsc_survey_disaggregated %>%
  mutate(comname = as.character(comname),
         EPU = as.character(EPU), 
         comname = gsub(" ", "_", comname)) %>%
  select(Season, EPU, comname, feeding_guild = `Feeding guild`) %>%
  right_join(sp_names, by = c("Season", "EPU", "comname")) %>% 
  distinct(.keep_all = TRUE)

```


```{r trend-load, eval=TRUE}

trend_dat <- best_mod %>% 
  select(EPU, Season, trends) %>% 
  unnest(trends) %>%
  mutate(term = gsub("X", "Trend ", term)) #%>%

load_dat <- best_mod %>% 
  select(EPU, Season, comname, z_rot) %>% 
  unnest(c(comname, z_rot)) %>% 
  ungroup() %>% 
  pivot_longer(-c(EPU, Season, comname), names_to = "trend", values_to = "val") %>%
  left_join(sp_guild, by = c("EPU", "Season", "comname")) %>%
  mutate(trend = gsub("X", "Trend ", trend)) %>% 
  na.omit(val)
# 
# trend_plot <- ggplot(data = trend_dat) +
#   geom_hline(yintercept = 0, color = "grey60") +
#   geom_line(aes(t, estimate)) +
#   geom_ribbon(aes(x=t, ymin=conf.low, ymax=conf.high), linetype=2, alpha=0.1) +
#   facet_grid(EPU + Season ~ term) +
#   labs(title = "DFA Trends",
#        y = "",
#        x = "Time") +
#   theme_bw()
# 
# trend_plot
```




<!-- ```{r loadings-plot, eval=TRUE, fig.align='center', fig.cap="Factor loadings by species and feeding guild.\\label{fig:loadings-plot}"} -->

<!-- load_dat <- best_mod %>%  -->
<!--   select(EPU, Season, comname, z_rot) %>%  -->
<!--   unnest(c(comname, z_rot)) %>%  -->
<!--   ungroup() %>%  -->
<!--   pivot_longer(-c(EPU, Season, comname), names_to = "trend", values_to = "val") %>% -->
<!--   left_join(sp_guild, by = c("EPU", "Season", "comname")) %>% -->
<!--   mutate(trend = gsub("X", "Trend ", trend)) %>%  -->
<!--   na.omit(val) -->

<!-- # load_plot <- ggplot(data = load_dat, aes(y = comname, xend = 0, yend = comname, x = val, color = feeding_guild)) + -->
<!-- #   geom_point() + -->
<!-- #   geom_segment()+ -->
<!-- #   facet_grid(EPU + Season ~ trend) + -->
<!-- #   scale_color_brewer(palette = "Dark2") + -->
<!-- #   # scale_y_discrete(limits = rev(levels(as.factor(load_dat$comname)))) + -->
<!-- #   labs(title = "DFA factor loadings", -->
<!-- #        subtitle = sprintf("Factor loadings by species and feeding guild"), -->
<!-- #        y = "Common name", -->
<!-- #        x = "loading", -->
<!-- #        color = "Feeding guild") + -->
<!-- #   theme_bw() + -->
<!-- #   theme(axis.text.y = element_text(size = rel(.6)), -->
<!-- #         legend.position = "bottom") + -->
<!-- #   NULL -->
<!-- # load_plot -->

<!-- ``` -->



```{r trend-load-plots, eval=TRUE, fig.align='center', fig.cap="DFA trends and factor loadings by species and feeding guild for each EPU and season.\\label{fig:trend-load-plot}"}

trend_nested <- 
  trend_dat %>% 
  group_by(EPU, Season) %>% 
  nest()

trend_nested_plots <- 
  trend_nested %>% 
  mutate(trend_plot = pmap(list(data, EPU, Season), function(x, y, z) ggplot(data = x) +
                       geom_hline(yintercept = 0, color = "grey60") +
                       geom_line(aes(t, estimate)) +
                       geom_ribbon(aes(x=t, ymin=conf.low, ymax=conf.high), linetype=2, alpha=0.1) +
                       facet_grid( ~ term) +
                       labs(title = sprintf("%s in the %s", y, z),
                            # subtitle = "DFA trends", 
                            # y = "",
                            x = "") +
                       theme_bw() +
                       NULL)) %>% 
  select(EPU, Season, trend_plot)

load_nested <- 
  load_dat %>% 
  group_by(EPU, Season) %>% 
  nest()

load_nested_plots <- 
  load_nested %>% 
  mutate(load_plot = pmap(list(data, EPU, Season), function(x, y, z) ggplot(data = x, 
                                                                       aes(y = as.factor(comname), 
                                                                           xend = 0, 
                                                                           yend = as.factor(comname), 
                                                                           x = val, 
                                                                           color = feeding_guild)) +
                       geom_point() +
                       geom_segment() +
                       facet_grid( ~ trend) +
                       scale_color_brewer(palette = "Dark2") +
                       scale_y_discrete(limits = rev(levels(as.factor(x$comname)))) +
                       labs(#title = sprintf("%s in the %s", y, z),
                            subtitle = "Factor loadings by species and feeding guild",
                            y = "Common name",
                            x = "loading",
                            color = "Feeding guild") +
                       theme_bw() +
                       theme(axis.text.y = element_text(size = rel(.7)),
                             legend.position = "bottom") +
                       NULL)) %>% 
  select(EPU, Season, load_plot)

all_plot <- load_nested_plots %>% 
  left_join(trend_nested_plots, by = c("EPU", "Season")) %>% 
  rowwise() %>%
  mutate( a = list( {trend_plot / load_plot})) #%>%
  # ungroup()

invisible(lapply(all_plot$a, function(x) print(x)))
```


```{r fits-plot, eval=TRUE, fig.height= 12, fig.cap="Estimated trend and 95% CI and raw data (blue dots).\\label{fig:fits-plot}"}

fit_dat <- best_mod %>% 
  select(EPU, Season, fits) %>% 
  unnest(fits) %>% 
  ungroup()

fit_nested <- fit_dat %>% 
  group_by(EPU, Season) %>% 
  nest()

fit_nested_plot <- fit_nested %>% 
  mutate(fit_plot = pmap(list(data, EPU, Season), function(x, y, z) ggplot(data = x, aes(x = Time, y = ex, ymin = lo, ymax = up)) +
                           geom_ribbon(color = "grey30", fill = "grey80") +
                           geom_point(data = x, aes(x = Time, y = raw), color = "#0055A4", alpha = .75) +
                           geom_line() +
                           facet_wrap( ~ comname) +
                           labs(title =  "Model fits",
                                subtitle = sprintf("and 95%% CI by species for %s in the %s", y, z),
                                # subtitle = sprintf("Model fits and 95%% CI by species for %s in the %s", y, z),
                                x = "Time",
                                y = "") +
                           theme_bw() +
                           theme(strip.text.x = element_text(size = 6))))

# fit_nested_plot$fit_plot
invisible(lapply(fit_nested_plot$fit_plot, function(x) print(x)))
# fit_plot <- ggplot(data = fit_dat, aes(x = Time, y = ex, ymin = lo, ymax = up, color = Season)) +
#   geom_ribbon(alpha = 0.1) +
#   geom_line() +
#   geom_point(data = fit_dat, aes(x = Time, y = raw, color = Season), alpha = .75) +
#   facet_wrap(comname ~ EPU, ncol = 1) +
#   labs(title = "DFA factor loadings",
#        # subtitle = sprintf("Model fits and 95%% CI by species for %s in the %s", epu, season),
#        x = "Time",
#        y = "") +
#   theme_bw()
# fit_plot

```


## Discussion


What's next: 
* 


