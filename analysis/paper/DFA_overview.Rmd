---
title: "Dynamic Factor Analysis"
author: "Scott Large"
date: "6/12/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# remotes::install_github("fate-ewi/bayesdfa")
# remotes::install_github("nwfsc-timeseries/MARSS")
# install.packages("broom")
# library(bayesdfa)
library(MARSS)
library(dplyr)
library(tidyr)
library(broom)
library(purrr)
library(ggplot2)
library(ggrepel)
library(patchwork)

##
get_dfa_fits <- function(MLEobj, dd = NULL, alpha = 0.05) {
  ## empty list for results
  fits <- list()
  ## extra stuff for var() calcs
  Ey <- MARSS:::MARSShatyt(MLEobj)
  ## model params
  ZZ <- coef(MLEobj, type = "matrix")$Z
  ## number of obs ts
  nn <- dim(Ey$ytT)[1]
  ## number of time steps
  TT <- dim(Ey$ytT)[2]
  ## get the inverse of the rotation matrix
  H_inv <- varimax(ZZ)$rotmat
  ## check for covars
  if (!is.null(dd)) {
    DD <- coef(MLEobj, type = "matrix")$D
    ## model expectation
    fits$ex <- ZZ %*% H_inv %*% MLEobj$states + DD %*% dd
  } else {
    ## model expectation
    fits$ex <- ZZ %*% H_inv %*% MLEobj$states
  }
  ## Var in model fits
  VtT <- MARSSkfss(MLEobj)$VtT
  VV <- NULL
  for (tt in 1:TT) {
    RZVZ <- coef(MLEobj, type = "matrix")$R - ZZ %*% VtT[,
                                                         , tt] %*% t(ZZ)
    SS <- Ey$yxtT[, , tt] - Ey$ytT[, tt, drop = FALSE] %*%
      t(MLEobj$states[, tt, drop = FALSE])
    VV <- cbind(VV, diag(RZVZ + SS %*% t(ZZ) + ZZ %*% t(SS)))
  }
  SE <- sqrt(VV)
  ## upper & lower (1-alpha)% CI
  fits$up <- qnorm(1 - alpha/2) * SE + fits$ex
  fits$lo <- qnorm(alpha/2) * SE + fits$ex
  return(fits)
}


```

## Introduction

1. EBFM and IEA yadda yadda yadda
1. The need for synthesis in IEAs
    + Improving story-telling with indexes
    + Creating hypotheses for causal relationships
    + Move from "so-what" towards opperational EBFM/EAFM
1. The State of the Ecosystem Report (SOE) has many indicators but explaining teleconnections and "bigger picture" messages remains a challenge.
1. Here, we seek to reduce the dimensionality of data to:
    + identify common trends between indicators to serve as an ecosystem index
    + identify covariates that improve explanatory power of common trends
    + ?
1. DFAs identify latent trends in time-series using some fancy-pants maths.
    + We are tracking stability using feeding guilds. 
        + If we use raw species kg/tow survey data to identify common trends between species, these might provide additional/better/other insight into ecosystem stability. 
        + Covariates can also be included to identify hypotheses that might be useful for improved management  
        + *n.b. VAST can do spatial DFA, so this could all be done within a single framework -- I don't know how or if it would require unreasonable computing resources* 
    + Potential covariate data: environmental (e.g., SST, BT, and chla) and socio-economic (e.g., revenue, engagement, landings, etc)

## Materials and Methods

# Data


1. Survey data
    + For each ecoregion, select the *n* species that occur in *x* tows and aggregate to annual/seasonal
    + *VAST, we would just need to filter for subset of species and not worry about aggregating to annual/seasonal values.*
1. Environmental data
    + For each ecoregion: Seasonal bottom temperature,
    + Basin-wide: NAO, AMO, ...? 
    + *VAST could use interpolated station data from Kevin*



# Modeling

We used [MARSS](https://cran.r-project.org/web/packages/MARSS/index.html) DFA as a dimension reduction tool. 



## Results


```{r get-fits}

# mod_path <- here::here("analysis/models")
mod_path <- "\\\\net.nefsc.noaa.gov/home5/slarge/projects/soe-synthesis/analysis/models/"
## This will take a while
all_out <- tibble(file_path = list.files(mod_path))

mod_list <- all_out %>%
  filter(!grepl("^kemz.*|model_out.*|marss-dfa.*|GB_fall-model_list.*", file_path)) %>% 
  mutate(out = gsub(".rds", "", file_path),
         file_path = paste0("\\\\net.nefsc.noaa.gov/home5/slarge/projects/soe-synthesis/analysis/models/", file_path)) %>% 
  separate(col = out, sep = "-", into = c("EPU", "Season", "R", "m",
                                          "covariateA", "covariateB", "covariateC", "covariateD"),
           fill = "right",
           remove = TRUE) %>% 
  mutate(covariateA = ifelse(covariateA == "NA",
                             NA, 
                             covariateA))

mod_out <- mod_list %>%
  filter(EPU == "GB") %>%
  group_by(EPU, Season) %>% 
  mutate(AICc = purrr::map(file_path, function(x) readRDS(x)$AICc)) %>%
  unnest(AICc) %>%
  ungroup()
  # arrange(AICc)

```



```{r model-selection, eval=TRUE, fig.align='center', fig.cap="DFA model selection for GB in the Fall.  \\label{fig:model-selection}"}

mod_plot <- mod_out %>%
  filter(R != "unconstrained") %>%
  group_by(EPU, Season) %>%
  mutate(delta_AICc = AICc - min(AICc)) %>% 
  ungroup() %>% 
  mutate(wt = exp(-0.5*delta_AICc),
         Ak_wt = wt/sum(wt),
         Ak_wt_cum = cumsum(Ak_wt),
         n_covariate = rowSums(!is.na(select(., starts_with("cov"))))) %>%
  pivot_longer(cols = starts_with("cov"), names_to = "all_cov") %>%
  select(-all_cov) %>%
  group_by(EPU, Season) %>%
  mutate(value = ifelse(n_covariate == 0,
                        "none", value),
         best_model = ifelse(AICc == min(AICc),
                             "Best Model",
                             NA)) %>%
  distinct(.keep_all = TRUE) %>%
  filter(!is.na(value))

# epu = unique(mod_plot$EPU)
# season = unique(mod_plot$Season)

model_plot <- ggplot() +
  geom_point(data = mod_plot %>%  filter(n_covariate <= 1),
             aes(x = m, y = delta_AICc, shape = R, color = value)) +
  geom_point(data = mod_plot %>%  filter(n_covariate >= 2),
             aes(x = m, y = delta_AICc, shape = R, color = value), position = position_jitter(w = 0.4, h = 0.0)) +
  geom_label_repel(
    data = mod_plot %>% filter(!is.na(best_model)), aes(x = m, y = delta_AICc), label = "Best Model",
    box.padding = 2, point.padding = 0, min.segment.length = 0, force = 0.5) +
  facet_grid(EPU + Season ~ n_covariate) +
  scale_fill_brewer(type = "qual", palette = "Set1") +
  labs(title = "DFA model selection",
       subtitle = sprintf("Number of covariates for %s", epu),
       color = "Covariate",
       y = "\u0394 AICc",
       x = "Number of trends") +
  theme_bw()

model_plot

best_mod <- mod_plot %>%
  filter(!is.na(best_model)) %>%
  group_by(EPU, Season) %>% 
  # nest() %>% 
  # pull(file_path) %>%
  mutate(dat = purrr::map(file_path, ~readRDS(.x)))
  # readRDS()
tt <- best_mod %>% 
  mutate(sp_dat = purrr::map(dat, c("call", "data")),
         comname = purrr::map(sp_dat, ~rownames(.x)))

sp_names <- tt %>% 
  select(EPU, Season, comname) %>% 
  unnest(comname)


# sp_names <- rownames(best_mod$call$data)

sp_guild <- ecodata::nefsc_survey_disaggregated %>%
  mutate(comname = as.character(comname),
         EPU = as.character(EPU), 
         comname = gsub(" ", "_", comname)) %>%
  select(Season, EPU, comname, feeding_guild = `Feeding guild`) %>%
  right_join(sp_names) %>% 
  # filter(comname %in% sp_names) %>%
  distinct(.keep_all = TRUE)


```


```{r trends-plot, eval=TRUE, fig.align='center', fig.cap="Estimated trend and 95% CI for the 'best model', a 4-trend DFA model with diagonal and equal covariance-variance matrices.\\label{fig:trends-plot}"}

td <- best_mod %>% 
  select(EPU, Season, dat) %>% 
  # group_by(EPU, Season) %>%
  mutate(d = map(dat, tidy, type = "states")) %>% 
  unnest(d) %>%
  mutate(term = gsub("X", "Trend ", term)) %>% 
  select(-dat)

# d <- tidy(best_mod, type="states") %>% 
#   mutate(term = case_when(term == "X1" ~ "Trend 1",
#                           term == "X2" ~ "Trend 2",
#                           term == "X3" ~ "Trend 3",
#                           term == "X4" ~ "Trend 4",
#                           TRUE ~ NA_character_))

tr_plot <- ggplot(data = td) +
  geom_hline(yintercept = 0, color = "grey60") +
  geom_line(aes(t, estimate)) +
  geom_ribbon(aes(x=t, ymin=conf.low, ymax=conf.high), linetype=2, alpha=0.1) +
  facet_grid(EPU + Season ~ term) +
  labs(title = "DFA Trends",
       y = "",
       x = "Time") +
  theme_bw()
tr_plot
```




```{r loadings-plot, eval=TRUE, fig.align='center', fig.cap="Factor loadings by species and feeding guild.\\label{fig:loadings-plot}"}

load_plot <- best_mod %>% 
  mutate(z_est = map(dat, ~coef(.x, type = "matrix")$Z),
         h_inv = map(z_est, ~varimax(.x)$rotmat),
         z_rot = map2(.x = z_est, .y = h_inv, ~ data.frame(.x %*% .y)),
         sp_dat = purrr::map(dat, c("call", "data")),
         comname = purrr::map(sp_dat, ~rownames(.x))) %>% 
  select(EPU, Season, comname, z_rot) %>% 
  unnest(c(comname, z_rot)) %>% 
  ungroup() %>% 
  pivot_longer(-c(EPU, Season, comname), names_to = "Trend", values_to = "val") %>%
  left_join(sp_guild, by = c("EPU", "Season", "comname")) %>%
  mutate(val = ifelse(abs(val) <= 0.05,
                      0,
                      val),
         comname = as.factor(comname))  


# ## get the estimated ZZ
# Z_est <- coef(best_mod, type = "matrix")$Z
# ## get the inverse of the rotation matrix
# H_inv <- varimax(Z_est)$rotmat
# 
# ## rotate factor loadings
# Z_rot = Z_est %*% H_inv
# colnames(Z_rot) <- paste0("Trend_", 1:ncol(Z_rot))

load_plot <- data.frame(Z_rot) %>%
  mutate(comname = sp_names) %>%
  pivot_longer(-comname, names_to = "Trend", values_to = "val") %>%
  left_join(sp_guild, by = "comname") %>%
  mutate(val = ifelse(abs(val) <= 0.05,
                      0,
                      val),
         comname = as.factor(comname))

# guild_pal <- RColorBrewer::brewer.pal(length(unique(load_plot$`Feeding guild`)), name = "Dark2")

load_plot <- ggplot(data = load_plot, aes(x = comname, yend = 0, xend = comname, y = val, color = feeding_guild)) +
  geom_point() +
  geom_segment()+
  facet_grid(EPU + Season ~ Trend) +
  coord_flip() +
  scale_color_brewer(palette = "Dark2") +
  scale_x_discrete(limits = rev(levels(load_plot$comname))) +
  theme(axis.text.y = element_text(size = 4)) +
  labs(title = "DFA factor loadings",
       subtitle = sprintf("Factor loadings by species and feeding guild"),
       x = "Common name",
       y = "loading") +
  theme_bw()
load_plot

```




```{r fits-plot, eval=TRUE, fig.align='center', fig.cap="Estimated trend and 95% CI and raw data (blue dots).\\label{fig:fits-plot}"}

mod_fits <- get_dfa_fits(best_mod)

sp_names <- rownames(best_mod$call$data)

ex <- data.frame(sp_names,
                 mod_fits$ex, stringsAsFactors = FALSE)
colnames(ex) = c("comname", colnames(best_mod$call$data))
ex <- ex %>%
  pivot_longer(-comname, names_to = "Time", values_to = "est")

up <- data.frame(sp_names,
                 mod_fits$up, stringsAsFactors = FALSE)
colnames(up) = c("comname", colnames(best_mod$call$data))
up <- up %>%
  pivot_longer(-comname, names_to = "Time", values_to = "up")

lo <- data.frame(sp_names,
                 mod_fits$lo, stringsAsFactors = FALSE)
colnames(lo) = c("comname", colnames(best_mod$call$data))
lo <- lo %>%
  pivot_longer(-comname, names_to = "Time", values_to = "lo")

raw <- data.frame(best_mod$marss$data) %>%
  tibble::rownames_to_column(var = "comname") %>%
  pivot_longer(-comname, names_to = "Time", values_to = "raw") %>%
  mutate(Time = gsub("X", "", Time))

mod_fits <- ex %>%
  left_join(up, by = c("comname", "Time")) %>%
  left_join(lo, by = c("comname", "Time")) %>%
  left_join(raw, by = c("comname", "Time")) %>%
  mutate(Time = as.numeric(Time))


fit_plot <- ggplot(data = mod_fits, aes(x = Time, y = est, ymin = lo, ymax = up)) +
  geom_ribbon(color = "grey60", alpha = 0.1) +
  geom_line() +
  geom_point(data = mod_fits, aes(x = Time, y = raw), color = "#0055A4", alpha = .75) +
  facet_wrap(~comname) +
  labs(title = "DFA factor loadings",
       subtitle = sprintf("Model fits and 95%% CI by species for %s in the %s", epu, season),
       x = "Time",
       y = "") +
  theme_bw()
fit_plot

```


## Discussion


